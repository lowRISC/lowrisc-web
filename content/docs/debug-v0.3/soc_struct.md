+++
Description = ""
date = "2016-07-08T11:00:00+00:00"
title = "Soc structure updates"
parent = "/docs/debug-v0.3/"
prev = "/docs/debug-v0.3/fpga/"
next = "/docs/debug-v0.3/add_device/"
showdisqus = true

+++

Thanks to the continuous development from the RISC-V group at UC Berkeley, 
there are a lot of structure changes and extra features incorporated in this 
release.

<a name="figure-overview"></a>
<img src="../figures/lowRISC_soc.png" alt="Drawing" style="width: 500px; padding: 20px 0px;"/>

 * **Shared TileLink MEM network for both cached (memory) accesses and uncached (IO) accesses.**
<br>In the previous untethered release, cached memory accesses and uncached IO 
accesses are separated early in the L1 D$, which has the benefit of small 
on-chip interconnects and less interference to the memory interconnect from IO 
transactions. However, this leads to troubles when a peripheral, such as a 
DMA, needs to access the memory (L2 cache). This release follows the choice 
from the upstream Rocket design that separates uncached IO transactions from 
cached memory accesses at the coherent TileLink MEM network. As a result, the 
debug MAM module can access memory as well as all IO space by a single access 
point to the MEM network.

* **A global memory space regulator: address map**
<br>A static data structure is added into the Rocket-chip to regulate the size 
and the R/W/X permission of all memory sections. It uses a hierarchical map to 
store all memory sections. For the standalone FPGA demo, the map should look 
like:<br><br>
&nbsp;&nbsp;`<"io", 0x00000000-0x7fffffff>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"int", 0x00000000-0x3fffffff>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"bootrom", 0x00000000-0x00001fff, RX>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"rtc", 0x00002000-0x00002fff, RW>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"prci0", 0x00003000-0x00003fff, RW>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"ext", 0x40000000-0x7fffffff>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"bram", 0x40000000-0x4000ffff, RWX>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"flash", 0x41000000-0x40ffffff, RX>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"uart", 0x42000000-0x42001fff, RW>`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<"spi", 0x42002000-0x42003fff, RW>`<br>
&nbsp;&nbsp;`<"mem", 0x80000000-0xffffffff, RWX>`<br>
<br>Note that the base address of each memory section is calculated automatically during the Chisel compilation. For a detail look of the address map, please read the related part in `$TOP/src/main/scala/Configs.scala` (initialization of the address map) and `$TOP/junctions/src/main/scala/addrmap.scala` (implementation of the address map).

* **Boot ROM**
<br>A boot ROM is added into the SoC, which should always located at the reset address (0x00000000 by default). The current boot ROM has two parts: The first several instructions redirect PC to the on-chip BRAM if it is enabled or to the DDR RAM. The rest of the ROM has a configuration string, which stores a simplified device tree. This configuration string identifies the number and types of processors on chip along with the address map. For the standalone FPGA demo, the configuration string should read as:<br><br>
&nbsp;&nbsp;`platform {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`vendor lowRISC;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`arch rocket;`<br>
&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;`rtc {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`addr 0x2000;`<br>
&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;`ram {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`0 {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`addr 0x80000000;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`size 0x8000000;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;`core {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`0 {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`0 {`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`isa rv64imafd;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`timecmp 0x2008;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`ipi 0x3000;`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`};`<br>
&nbsp;&nbsp;`};`<br>
<br>This configuration string is automatically generated by `makeBootROM()` in `$TOP/src/main/scala/LowRISCChip.scala` Note that not all sections in address map is recorded in the configuration string. We will rectify this soon. With this configuration string in the boot ROM, bootloaders and the Linux kernel are able to probe the SoC structure without external device tree files.
